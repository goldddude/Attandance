<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Attend</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles-dark.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üìä</div>
                    <span>Attend</span>
                </a>
                <nav class="nav">
                    <a href="index.html" class="nav-link">Overview</a>
                    <a href="dashboard.html" class="nav-link active">Dashboard</a>
                    <a href="students.html" class="nav-link">Students</a>
                    <a href="scan-attendance.html" class="nav-link">Scan</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Welcome Header -->
            <div style="margin-bottom: 2rem;">
                <h1>Hello Admin! üëã</h1>
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">We hope you're having a great day.</p>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon success">üë•</div>
                    </div>
                    <div class="stat-value" id="total-students">0</div>
                    <div class="stat-label">Total Students</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon success">‚úì</div>
                    </div>
                    <div class="stat-value" id="present-today">0</div>
                    <div class="stat-label">Present Today</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon error">‚úó</div>
                    </div>
                    <div class="stat-value" id="absent-today">0</div>
                    <div class="stat-label">Absent Today</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon warning">‚è∞</div>
                    </div>
                    <div class="stat-value" id="late-students">0</div>
                    <div class="stat-label">Late Students</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-2">
                <!-- Attendance Report -->
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <h3 class="card-title">Total Attendance Report</h3>
                        <p class="card-subtitle">Last 7 days attendance trends</p>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="attendanceChart"></canvas>
                    </div>
                </div>

                <!-- Students by Gender -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Students by Gender</h3>
                        <p class="card-subtitle">Gender distribution</p>
                    </div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="genderChart"></canvas>
                    </div>
                </div>

                <!-- Top 6 Attendant -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Top 6 Attendant</h3>
                        <p class="card-subtitle">Students with best attendance</p>
                    </div>
                    <div class="top-list" id="top-attendees">
                        <div class="loading-container">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Students by Class -->
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <h3 class="card-title">Students by Class</h3>
                        <p class="card-subtitle">Distribution across sections</p>
                    </div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="classChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header flex-between">
                    <div>
                        <h3 class="card-title">Recent Attendance</h3>
                        <p class="card-subtitle">Latest attendance recordings</p>
                    </div>
                    <button onclick="loadRecentAttendance()" class="btn btn-secondary">üîÑ Refresh</button>
                </div>
                <div id="recent-attendance">
                    <div class="loading-container">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        let attendanceChart, genderChart, classChart;

        async function loadStats() {
            try {
                const stats = await APIClient.getAttendanceStats();

                document.getElementById('total-students').textContent = stats.total_students;
                document.getElementById('present-today').textContent = stats.today_unique_students;
                document.getElementById('absent-today').textContent = stats.total_students - stats.today_unique_students;
                document.getElementById('late-students').textContent = '0'; // Placeholder

            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        function createAttendanceChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');

            // Generate last 7 days
            const dates = [];
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                // Simulate data - in real app, fetch from API
                data.push(Math.floor(Math.random() * 20) + 30);
            }

            attendanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Present Students',
                        data: data,
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#4ade80',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#2d313e',
                            titleColor: '#ffffff',
                            bodyColor: '#94a3b8',
                            borderColor: '#374151',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#374151',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }

        function createGenderChart() {
            const ctx = document.getElementById('genderChart').getContext('2d');

            // Simulated data - in real app, fetch from API
            genderChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Male', 'Female'],
                    datasets: [{
                        data: [55, 45],
                        backgroundColor: ['#1e293b', '#4ade80'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#94a3b8',
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#2d313e',
                            titleColor: '#ffffff',
                            bodyColor: '#94a3b8',
                            borderColor: '#374151',
                            borderWidth: 1,
                            padding: 12
                        }
                    }
                }
            });
        }

        async function loadTopAttendees() {
            const container = document.getElementById('top-attendees');

            try {
                // Get all students and their attendance count
                const studentsData = await APIClient.getStudents();
                const students = studentsData.students.slice(0, 6);

                if (students.length === 0) {
                    container.innerHTML = '<p class="text-secondary text-center" style="padding: 2rem;">No students yet</p>';
                    return;
                }

                container.innerHTML = students.map((student, index) => `
                    <div class="top-list-item">
                        <div class="top-list-avatar">${student.name.charAt(0)}</div>
                        <div class="top-list-info">
                            <div class="top-list-name">${student.name}</div>
                            <div class="top-list-detail">${student.register_number}</div>
                        </div>
                        <div class="top-list-value">${Math.floor(Math.random() * 10) + 20} days</div>
                    </div>
                `).join('');

            } catch (error) {
                container.innerHTML = '<p class="text-secondary">Failed to load data</p>';
            }
        }

        async function createClassChart() {
            const ctx = document.getElementById('classChart').getContext('2d');

            try {
                const studentsData = await APIClient.getStudents();
                const students = studentsData.students;

                // Count by section
                const sectionCounts = {};
                students.forEach(student => {
                    sectionCounts[student.section] = (sectionCounts[student.section] || 0) + 1;
                });

                const sections = Object.keys(sectionCounts).sort();
                const counts = sections.map(s => sectionCounts[s]);

                classChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sections.length > 0 ? sections : ['A', 'B', 'C', 'D', 'E'],
                        datasets: [{
                            label: 'Students',
                            data: counts.length > 0 ? counts : [12, 19, 15, 10, 8],
                            backgroundColor: '#4ade80',
                            borderRadius: 8,
                            barThickness: 40
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: '#2d313e',
                                titleColor: '#ffffff',
                                bodyColor: '#94a3b8',
                                borderColor: '#374151',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#374151',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    stepSize: 5
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#94a3b8'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to create class chart:', error);
            }
        }

        async function loadRecentAttendance() {
            const container = document.getElementById('recent-attendance');
            UI.showLoading(container);

            try {
                const data = await APIClient.getRecentAttendance(15);

                if (data.attendance.length === 0) {
                    container.innerHTML = '<p class="text-secondary text-center" style="padding: 2rem;">No attendance records yet</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Student Name</th>
                                    <th>Register Number</th>
                                    <th>Section</th>
                                    <th>Recorded By</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.attendance.map(record => `
                                    <tr>
                                        <td><strong>${UI.formatTime(record.timestamp)}</strong></td>
                                        <td>${record.student_name}</td>
                                        <td>${record.register_number}</td>
                                        <td><span class="badge badge-success">Present</span></td>
                                        <td>${record.recorded_by}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">Failed to load attendance: ${error.message}</div>`;
            }
        }

        // Initialize dashboard
        loadStats();
        createAttendanceChart();
        createGenderChart();
        loadTopAttendees();
        createClassChart();
        loadRecentAttendance();
    </script>
</body>

</html>