<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Students - TapSyncPro</title>
    <link rel="stylesheet" href="css/styles-pro.css">
    <style>
        .section-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .section-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: var(--transition);
            white-space: nowrap;
        }

        .section-tab:hover {
            color: var(--text-primary);
        }

        .section-tab.active {
            color: var(--primary);
        }

        .section-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .action-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <div class="logo-icon">‚ö°</div>
                    <span>TapSyncPro</span>
                </a>
                <nav class="nav">
                    <a href="index.html" class="nav-link">Overview</a>
                    <a href="dashboard.html" class="nav-link">Dashboard</a>
                    <a href="students.html" class="nav-link active">Students</a>
                    <a href="scan-attendance.html" class="nav-link">Scan</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="flex-between" style="margin-bottom: 2rem;">
                <div>
                    <h1>Student Management</h1>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">Manage student profiles and NFC
                        registrations</p>
                </div>
                <div class="flex gap-2">
                    <a href="add-student.html" class="btn btn-primary">‚ûï Add Student</a>
                    <a href="upload-students.html" class="btn btn-secondary">üì§ Upload Excel</a>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="form-group" style="margin-bottom: 0;">
                    <input type="text" id="search" class="form-input"
                        placeholder="üîç Search by name or register number...">
                </div>
            </div>

            <!-- Section Tabs -->
            <div class="section-tabs" id="section-tabs">
                <button class="section-tab active" data-section="all">All Students</button>
            </div>

            <!-- Students List -->
            <div class="card">
                <div class="card-header flex-between">
                    <div>
                        <h3 class="card-title">Students List</h3>
                        <p class="card-subtitle" id="student-count">Loading...</p>
                    </div>
                    <button onclick="loadStudents()" class="btn btn-secondary">üîÑ Refresh</button>
                </div>

                <div id="students-container">
                    <div class="loading-container">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/app.js"></script>
    <script>
        let allStudents = [];
        let sections = new Set();
        let currentSection = 'all';

        async function loadStudents() {
            const container = document.getElementById('students-container');
            container.innerHTML = '<div class="loading-container"><div class="spinner"></div></div>';

            try {
                const data = await APIClient.getStudents();
                allStudents = data.students;

                // Extract unique sections
                sections.clear();
                sections.add('all');
                allStudents.forEach(student => {
                    if (student.section) sections.add(student.section);
                });

                // Update section tabs
                updateSectionTabs();

                // Display students
                filterAndDisplay();

            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        <div>
                            <strong>Error loading students</strong>
                            <p style="margin-top: 0.5rem;">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        function updateSectionTabs() {
            const tabsContainer = document.getElementById('section-tabs');
            const sortedSections = Array.from(sections).sort((a, b) => {
                if (a === 'all') return -1;
                if (b === 'all') return 1;
                return a.localeCompare(b);
            });

            tabsContainer.innerHTML = sortedSections.map(section => `
                <button 
                    class="section-tab ${section === currentSection ? 'active' : ''}" 
                    data-section="${section}"
                    onclick="selectSection('${section}')"
                >
                    ${section === 'all' ? 'All Students' : `Section ${section}`}
                </button>
            `).join('');
        }

        function selectSection(section) {
            currentSection = section;
            updateSectionTabs();
            filterAndDisplay();
        }

        function filterAndDisplay() {
            const searchTerm = document.getElementById('search').value.toLowerCase();

            let filtered = allStudents;

            // Section filter
            if (currentSection !== 'all') {
                filtered = filtered.filter(s => s.section === currentSection);
            }

            // Search filter
            if (searchTerm) {
                filtered = filtered.filter(student =>
                    student.name.toLowerCase().includes(searchTerm) ||
                    student.register_number.toLowerCase().includes(searchTerm)
                );
            }

            displayStudents(filtered);

            const totalText = currentSection === 'all'
                ? `${filtered.length} of ${allStudents.length} students`
                : `${filtered.length} students in Section ${currentSection}`;

            document.getElementById('student-count').textContent = totalText;
        }

        function displayStudents(students) {
            const container = document.getElementById('students-container');

            if (students.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                        <h3>No students found</h3>
                        <p style="margin-top: 0.5rem;">
                            ${currentSection === 'all' ? 'Add your first student to get started' : `No students in Section ${currentSection}`}
                        </p>
                        <a href="add-student.html" class="btn btn-primary" style="margin-top: 1rem;">Add Student</a>
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Register No.</th>
                                <th>Name</th>
                                <th>Section</th>
                                <th>Department</th>
                                <th>NFC Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map(student => `
                                <tr id="student-row-${student.id}">
                                    <td><strong>${student.register_number}</strong></td>
                                    <td>${student.name}</td>
                                    <td><span class="badge badge-info">SEC ${student.section}</span></td>
                                    <td>${student.department}</td>
                                    <td>
                                        ${student.nfc_tag_id
                    ? '<span class="badge badge-success">‚úì Registered</span>'
                    : '<span class="badge badge-warning">‚ö† Not Registered</span>'
                }
                                    </td>
                                    <td>
                                        <a href="student-profile.html?id=${student.id}" class="btn btn-secondary action-btn">
                                            üëÅ View
                                        </a>
                                        <button onclick="deleteStudent(${student.id}, '${student.name}')" class="btn btn-danger action-btn">
                                            üóë Delete
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHtml;
        }

        async function deleteStudent(studentId, studentName) {
            if (!confirm(`Delete student "${studentName}"?\n\nThis will also delete all their attendance records. This action cannot be undone.`)) {
                return;
            }

            try {
                await APIClient.deleteStudent(studentId);

                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success';
                alertDiv.innerHTML = `
                    <div>
                        <strong>‚úì Success!</strong>
                        <p style="margin-top: 0.25rem;">Student "${studentName}" deleted successfully</p>
                    </div>
                `;
                const card = document.querySelector('.card');
                card.parentElement.insertBefore(alertDiv, card);

                setTimeout(() => alertDiv.remove(), 3000);

                // Remove row from table with animation
                const row = document.getElementById(`student-row-${studentId}`);
                if (row) {
                    row.style.transition = 'all 0.3s ease';
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        // Reload students
                        loadStudents();
                    }, 300);
                }

            } catch (error) {
                alert(`Failed to delete student: ${error.message}`);
            }
        }

        // Event listeners
        document.getElementById('search').addEventListener('input', filterAndDisplay);

        // Load students on page load
        loadStudents();
    </script>
</body>

</html>